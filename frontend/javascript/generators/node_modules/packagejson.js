import {CONSTANTS} from '../../constants';
import {FIELDS} from '../data/packagejson';
import File from '../../utils/file';
import FieldCheck from '../../utils/field-check';
import Toggle from '../../utils/toggle';
import FieldOutput from '../../utils/field-output';
import Prism from 'prismjs';
import 'prismjs/components/prism-json';
import Download from '../../utils/download';

let CODE = '';

const packagejson = {
  getUploadDetails: function() {
    var results = JSON.parse(new File().read());
    for (let i = 0; i < FIELDS.length; i++) {
      const field = FIELDS[i];
      new FieldCheck(field.name, results, field.type, field.fields, field.optional);
    }
  },
  
  generateOutput: function() {
    const outputForm = document.getElementById(CONSTANTS.OUTPUTFORM);
    var text = CONSTANTS.CURLYBRAKETSTART;
    for (let i = 0; i < FIELDS.length; i++) {
      const field = FIELDS[i];
      if (new Toggle(field.name + CONSTANTS.TOGGLE).isActive() == CONSTANTS.TRUE) {
        text += new FieldOutput(field.name, field.type, field.fields).build();
      }
    }

    if (text.slice(-2) == CONSTANTS.COMMASPACE) text = text.slice(0, -2);
    text += CONSTANTS.CURLYBRAKETEND;
    CODE = JSON.stringify(JSON.parse(text), null, 2);
    outputForm.innerHTML = CONSTANTS.NEWLINE + CODE;
    Prism.highlightAll();
    new Download(FILENAME, FILEMETA);
  }
};

const FILENAME = 'package.json';
const FILEMETA = 'application/json;charset=utf-8';

window.packagejson = packagejson;
